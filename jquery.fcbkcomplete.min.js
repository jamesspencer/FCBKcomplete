/* FCBKcomplete 2.7.4 - Jquery version required: 1.2.x, 1.3.x, 1.4.x  Changelog: - 2.00	new version of fcbkcomplete  - 2.01 fixed bugs & added features 		fixed filter bug for preadded items		focus on the input after selecting tag		the element removed pressing backspace when the element is selected		input tag in the control has a border in IE7		added iterate over each match and apply the plugin separately		set focus on the input after selecting tag  - 2.02 fixed fist element selected bug		fixed defaultfilter error bug  - 2.5 	removed selected="selected" attribute due ie bug		element search algorithm changed		better performance fix added		fixed many small bugs		onselect event added		onremove event added  - 2.6 	ie6/7 support fix added		added new public method addItem due request		added new options "firstselected" that you can set true/false to select first element on dropdown list		autoexpand input element added		removeItem bug fixed		and many more bug fixed 		fixed public method to use it $("elem").trigger("addItem",[{"title": "test", "value": "test"}]);		- 2.7 	jquery 1.4 compability 		item lock possability added by adding locked class to preadded option <option value="value" class="selected locked">text</option> 		maximum item that can be added- 2.7.1 bug fixed		ajax delay added thanks to http://github.com/dolorian- 2.7.2 some minor bug fixed		minified version recompacted due some problems		- 2.7.3 event call fixed thanks to William Parry <williamparry!at!gmail.com>- 2.7.4 standart event change call added on addItem, removeItem		preSet also check if item have "selected" attribute		addItem minor fix		- 2.7.5 added options "chooseOnEnter,chooseOnTab,chooseOnComma" to control what keys trigger selection		added option "keepPromptAfterChoose" to control if we stay selected/focused after choosing an option		added options "forceWidth" and "autoWidth" to control width setting (if both are null || false, no width is set in JS) - 2.7.6 added option "onBlurAddTag" this will add the text in the input box on leaving as a tag. - 2.7.7 small patch to allow the use of non-(multi)select inputs- 2.7.8 ie6 fix to test for presence of a function rather than length *//* Coded by: emposha <admin@emposha.com> *//* Copyright: Emposha.com <http://www.emposha.com/> - Distributed under MIT - Keep this message! *//* * json_url         - url to fetch json object * cache       		- use cache * height           - maximum number of element shown before scroll will apear * newel            - show typed text like a element * firstselected	- automaticly select first element from dropdown * filter_case      - case sensitive filter * filter_selected  - filter selected items from list * complete_text    - text for complete page * maxshownitems	- maximum numbers that will be shown at dropdown list (less better performance) * onselect			- fire event on item select * onremove			- fire event on item remove * maxitimes		- maximum items that can be added * delay			- delay between ajax request (bigger delay, lower server time request) */ jQuery(function(g){g.fn.fcbkcomplete=function(J){return this.each(function(){function r(e,a,b,j,n){if(!C())return false;var h=document.createElement("li"),u=document.createTextNode(e),s=document.createElement("a");j="bit-box"+(j?" locked":"");g(h).attr({"class":j,rel:a});g(h).prepend(u);g(s).attr({"class":"closebutton",href:"#"});h.appendChild(s);m.append(h);g(s).click(function(){D(g(this).parent("li"));return false});if(!b){g("#"+v+"_annoninput").remove();E(n);if(k.children("option[value="+a+"]").length){b=k.children("option[value="+a+"]");b.get(0).setAttribute("selected","selected");b.hasClass("selected")||b.addClass("selected")}else{b=g(document.createElement("option"));b.attr("value",a).get(0).setAttribute("selected","selected");b.attr("value",a).addClass("selected");b.text(e);k.is("select")&&k.append(b)}c.onselect&&F(c.onselect,b);k.change()}m.children("li.bit-box.deleted").removeClass("deleted");d.hide();q&&o.hide()}function D(e){if(!e.hasClass("locked")){e.fadeOut("fast");if(c.onremove.length){var a=k.children("option[value="+e.attr("rel")+"]");F(c.onremove,a)}k.children('option[value="'+e.attr("rel")+'"]').removeAttr("selected").removeClass("selected");e.remove();k.change();x=0}}function E(e){var a=g(document.createElement("li")),b=g(document.createElement("input")),j=0;a.attr({"class":"bit-input",id:v+"_annoninput"});b.attr({type:"text","class":"maininput",size:"1"});m.append(a.append(b));b.focus(function(){l.fadeIn("fast")});b.blur(function(){l.fadeOut("fast")});m.click(function(){b.focus();if(d.length&&b.val().length)d.show();else{d.hide();q&&o.hide();l.children(".default").show()}});b.keypress(function(n){if(n.keyCode==13&&c.chooseOnEnter||n.keyCode==9&&c.chooseOnTab)return false;b.attr("size",b.val().length+1)});b.keydown(function(n){if(n.keyCode==191){n.preventDefault();return false}});b.keyup(function(n){var h=y(b.val());if(n.keyCode==8&&h.length==0){d.hide();q&&o.hide();if(!m.children("li.bit-box:last").hasClass("locked"))if(m.children("li.bit-box.deleted").length==0){m.children("li.bit-box:last").addClass("deleted");return false}else{if(x)return;x=1;m.children("li.bit-box.deleted").fadeOut("fast",function(){D(g(this));return false})}}if(n.keyCode!=40&&n.keyCode!=38&&h.length!=0){w=0;if(c.json_url)if(c.cache&&G){z(h);A()}else{j++;var u=j;setTimeout(function(){if(u==j)g.getJSON(c.json_url+(c.json_url.indexOf("?")>-1?"&":"?")+"tag="+h,null,function(s){z(h,s);G=true;A()})},c.delay)}else{z(h);A()}l.children(".default").hide();d.show()}});e&&setTimeout(function(){b.focus();l.children(".default").show()},1)}function z(e,a){d.html("");if(!c.cache&&a!=null){p=[];t=""}K(e);a!=null&&a.length&&g.each(a,function(s,B){p.push({caption:B.caption,value:B.value});t+=""+(p.length-1)+":"+B.caption+";"});var b=c.maxshownitems<p.length?c.maxshownitems:p.length,j="i";if(c.filter_case)j="";var n,h;try{n=eval("/(?:^|;)\\s*(\\d+)\\s*:[^;]*?"+e+"[^;]*/g"+j);h=n.exec(t)}catch(u){}for(j="";h!=null&&b>0;){h=p[h[1]];if(!(c.filter_selected&&k.children("option[value="+h.value+"]").hasClass("selected"))){j+='<li rel="'+h.value+'">'+L(h.caption,e)+"</li>";w++;b--}h=n.exec(t)}d.append(j);if(c.firstselected){f=d.children("li:visible:first");f.addClass("auto-focus")}if(w>c.height){d.css({height:c.height*24+"px",overflow:"auto"});if(q){c.autoWidth&&o.css({width:d.width()+"px"});o.css({height:c.height*24+"px"}).show()}}else{d.css("height","auto");if(q){c.autoWidth&&o.css({width:d.width()+"px"});o.css({height:d.height()+"px"}).show()}}}function L(e,a){if(c.filter_case)try{eval("var text = text.replace(/(.*)("+a+")(.*)/gi,'$1<em>$2</em>$3');")}catch(b){}else try{eval("var text = text.replace(/(.*)("+a.toLowerCase()+")(.*)/gi,'$1<em>$2</em>$3');")}catch(j){}return e}function H(){d.children("li").mouseover(function(){d.children("li").removeClass("auto-focus");g(this).addClass("auto-focus");f=g(this)});d.children("li").mouseout(function(){g(this).removeClass("auto-focus");f=null})}function I(){d.children("li").unbind("mouseover");d.children("li").unbind("mouseout");d.mousemove(function(){H();d.unbind("mousemove")})}function A(){var e=g("#"+v+"_annoninput").children(".maininput");H();d.children("li").unbind("mousedown");d.children("li").mousedown(function(){var a=g(this);r(a.text(),a.attr("rel"));d.hide();q&&o.hide();l.hide();c.keepPromptAfterChoose&&g("#tags_annoninput .maininput").focus()});if(c.onBlurAddTag){e.unbind("blur");e.blur(function(){if(c.newel){var a=y(g(this).val());r(a,a);l.hide();event.preventDefault();f=null}c.keepPromptAfterChoose&&m.trigger("click")})}e.unbind("keydown");e.keydown(function(a){if(a.keyCode==191){a.preventDefault();return false}a.keyCode!=8&&m.children("li.bit-box.deleted").removeClass("deleted");if(a.keyCode==13&&c.chooseOnEnter||a.keyCode==9&&c.chooseOnTab||a.keyCode==188&&c.chooseOnComma){if(M()){var b=f;r(b.text(),b.attr("rel"));l.hide();a.preventDefault();f=null}else if(c.newel){b=y(g(this).val());r(b,b);l.hide();a.preventDefault();f=null}c.keepPromptAfterChoose&&m.trigger("click");return false}if(a.keyCode==40){I();if(f==null||f.length==0){f=d.children("li:visible:first");d.get(0).scrollTop=0}else{f.removeClass("auto-focus");f=f.nextAll("li:visible:first");b=parseInt(f.prevAll("li:visible").length,10);var j=parseInt(f.nextAll("li:visible").length,10);if((b>Math.round(c.height/2)||j<=Math.round(c.height/2))&&typeof f.get(0)!="undefined")d.get(0).scrollTop=parseInt(f.get(0).scrollHeight,10)*(b-Math.round(c.height/2))}d.children("li").removeClass("auto-focus");f.addClass("auto-focus")}if(a.keyCode==38){I();if(f==null||f.length==0){f=d.children("li:visible:last");d.get(0).scrollTop=parseInt(f.get(0).scrollHeight,10)*(parseInt(d.children("li:visible").length,10)-Math.round(c.height/2))}else{f.removeClass("auto-focus");f=f.prevAll("li:visible:first");b=parseInt(f.prevAll("li:visible").length,10);j=parseInt(f.nextAll("li:visible").length,10);if((j>Math.round(c.height/2)||b<=Math.round(c.height/2))&&typeof f.get(0)!="undefined")d.get(0).scrollTop=parseInt(f.get(0).scrollHeight,10)*(b-Math.round(c.height/2))}d.children("li").removeClass("auto-focus");f.addClass("auto-focus")}})}function C(){if(c.maxitems!=0)return m.children("li.bit-box").length<c.maxitems?true:false}function K(e){if(c.newel&&C()){d.children("li[fckb=1]").remove();if(e.length!=0){var a=g(document.createElement("li"));a.attr({rel:e,fckb:"1"}).html(e);d.prepend(a);w++}}}function F(e,a){var b="";for(i=0;i<a.get(0).attributes.length;i++)if(a.get(0).attributes[i].nodeValue!=null)b+='"_'+a.get(0).attributes[i].nodeName+'": "'+a.get(0).attributes[i].nodeValue+'",';b="{"+b+" notinuse: 0}";e.call(e,b)}function M(){if(f==null)return false;if(f.length==0)return false;return true}function y(e){e=e.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,'""');e=e.replace(/script(.*)/g,"");e=e.replace(/eval\((.*)\)/g,"");return e=e.replace("/([\u0000-\u0008,\u000b-\u000c,\u000e-\u0019])/","")}g(this).bind("addItem",function(e,a){r(a.title,a.value,0,0,0)});var c=g.extend({json_url:null,cache:false,height:"10",newel:false,firstselected:false,filter_case:false,filter_hide:false,complete_text:"Start to type...",maxshownitems:30,maxitems:10,onselect:"",onremove:"",delay:350,forceWidth:null,autoWidth:true,chooseOnComma:true,chooseOnTab:true,chooseOnEnter:true,keepPromptAfterChoose:true,onBlurAddTag:false},J),m=null,d=null,l=null,w=0,p=[],G=false,t="",f=null,x=0,q=false,o,k=g(this),v=k.attr("id");k.hide();k.attr("multiple","multiple");k.attr("name").indexOf("[]")==-1&&k.attr("name",k.attr("name")+"[]");m=g(document.createElement("ul"));m.attr("class","holder");k.after(m);l=g(document.createElement("div"));l.addClass("facebook-auto");l.append('<div class="default">'+c.complete_text+"</div>");if(q){l.append('<iframe class="ie6fix" scrolling="no" frameborder="0"></iframe>');o=l.children(".ie6fix")}d=g(document.createElement("ul"));d.attr("id",v+"_feed");l.prepend(d);m.after(l);if(c.forceWidth)d.css("width",c.width);else c.autoWidth&&d.css("width",l.width());(function(){k.children("option").each(function(e,a){a=g(a);if(a.hasClass("selected")||a.is(":selected")){r(a.text(),a.val(),true,a.hasClass("locked"));a.attr("selected","selected")}else a.removeAttr("selected");p.push({caption:a.text(),value:a.val()});t+=""+(p.length-1)+":"+a.text()+";"})})();E(0);return this})}});